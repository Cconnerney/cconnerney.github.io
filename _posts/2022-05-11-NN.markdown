---
layout: post
title: Neural Network
description: The model implements an image classification system using a single hidden layer neural network with Adagrad, a variant of stochastic gradient descent. The neural net creates an optical character recognizer with sigmoid activations and softmax output. 
img: pics.jpg # Add image post (optional)
tags: [ML, NeuralNetwork]
---

<html>
<head><meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>NN</title><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
  
  
<!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe"> </script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
    <!-- End of mathjax configuration --></head>
<body>

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Neural-Network">Neural Network<a class="anchor-link" href="#Neural-Network">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The model implements an image classification system using a single hidden layer neural network with Adagrad, a variant of stochastic gradient descent. The neural net creates an optical character recognizer with sigmoid activations and softmax output. The program learns the parameters of the model on the training data, reports the cross-entropy at the end of each epoch on both train and validation data, and at the end of training writes out predictions and error rates. Adagrad works to implicitly change the step size based on the shape of the function inferred from the gradients.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">train_input</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">validation_input</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">train_out</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">validation_out</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="n">metrics_out</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="n">num_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="n">hidden_units</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
<span class="n">init_flag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">erate</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span><span class="n">outlabels</span><span class="p">):</span>

    <span class="n">wrong_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">outlabels</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">wrong_count</span> <span class="o">+=</span><span class="mi">1</span>
    
    <span class="n">error_rate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wrong_count</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">error_rate</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">error_rate</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">error_rate</span>

<span class="k">def</span> <span class="nf">backward</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">upB</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">learnrate</span><span class="p">,</span><span class="n">sbeta</span><span class="p">,</span><span class="n">salpha</span><span class="p">):</span>

    <span class="nb">input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">alphaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">upA</span><span class="p">)</span>
    <span class="n">betaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">upB</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">alphaw</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">))</span>
    <span class="n">zw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">zw</span><span class="p">,</span><span class="n">betaw</span><span class="p">)</span>
    <span class="n">yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">labels</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">yhat</span><span class="p">)))</span>

    <span class="c1"># Beta</span>
    <span class="n">dl_db</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">yhat</span><span class="o">-</span><span class="n">labels</span><span class="p">)</span> 
    <span class="n">dl_dbeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">dl_db</span><span class="p">,</span><span class="n">zw</span><span class="p">)</span>

    <span class="n">betaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">betaw</span><span class="p">)</span>

    <span class="c1"># z</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">betaw</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dl_dz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dl_db</span><span class="p">),</span><span class="n">beta</span><span class="p">)</span>

    <span class="c1"># a</span>
    <span class="n">dz_da</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">z</span><span class="p">)</span>
    <span class="n">dl_da</span> <span class="o">=</span> <span class="p">(</span><span class="n">dl_dz</span><span class="p">)</span><span class="o">*</span><span class="n">dz_da</span>

    <span class="c1"># alpha </span>
    <span class="n">dl_dalpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">dl_da</span><span class="p">),</span><span class="nb">input</span><span class="p">)</span>

    <span class="c1"># beta update</span>
    <span class="n">sbeta</span> <span class="o">=</span> <span class="n">sbeta</span> <span class="o">+</span> <span class="n">dl_dbeta</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">upB</span> <span class="o">=</span> <span class="n">betaw</span> <span class="o">-</span> <span class="p">((</span><span class="n">learnrate</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sbeta</span><span class="o">+</span><span class="mf">1e-5</span><span class="p">))</span><span class="o">*</span><span class="n">dl_dbeta</span><span class="p">)</span>

    <span class="c1"># alpha update</span>
    <span class="n">salpha</span> <span class="o">=</span> <span class="n">salpha</span> <span class="o">+</span> <span class="n">dl_dalpha</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">upA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">alphaw</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">learnrate</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">salpha</span><span class="o">+</span><span class="mf">1e-5</span><span class="p">))</span><span class="o">*</span><span class="n">dl_dalpha</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">upB</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">sbeta</span><span class="p">,</span><span class="n">salpha</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">loss</span>

<span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">init_flag</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">init_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>\
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>\
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">hidden_units</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">init_flag</span> <span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">hidden_units</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">hidden_units</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span>

<span class="k">def</span> <span class="nf">CEloss</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">upB</span><span class="p">):</span>
    <span class="n">bigloss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">alphaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">upA</span><span class="p">)</span>
        <span class="n">betaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">upB</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">alphaw</span><span class="p">)</span>

        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">))</span>
        <span class="n">zw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">zw</span><span class="p">,</span><span class="n">betaw</span><span class="p">)</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">yhat</span><span class="p">)))</span>
        <span class="n">bigloss</span> <span class="o">+=</span> <span class="n">loss</span>

    <span class="n">ans</span> <span class="o">=</span> <span class="n">bigloss</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ans</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">upB</span><span class="p">,</span><span class="n">num_epoch</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">learnrate</span><span class="p">,</span><span class="n">inputv</span><span class="p">,</span><span class="n">labelsv</span><span class="p">):</span>
    <span class="n">sbeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">upB</span><span class="p">)</span>
    <span class="n">salpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">upA</span><span class="p">)</span>
    <span class="n">cross</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">emp</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">emptrain</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epoch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)):</span>
            <span class="n">upB</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">sbeta</span><span class="p">,</span><span class="n">salpha</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">loss</span> <span class="o">=</span> <span class="n">backward</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">upA</span><span class="p">,</span><span class="n">upB</span><span class="p">,</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">learnrate</span><span class="p">,</span><span class="n">sbeta</span><span class="p">,</span><span class="n">salpha</span><span class="p">)</span>
            <span class="c1">#if i &lt;10:</span>
                <span class="c1">#print(&#39;update&#39;,i+1,&#39;Beta&#39;)</span>
                <span class="c1">#print(upB,&#39;\n&#39;)</span>
                <span class="c1">#print(&#39;update&#39;,i+1,&#39;Alpha&#39;)</span>
                <span class="c1">#print(upA,&#39;\n&#39;)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">CEloss</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">upB</span><span class="p">)</span>
        <span class="n">ans2</span> <span class="o">=</span> <span class="n">CEloss</span><span class="p">(</span><span class="n">inputv</span><span class="p">,</span><span class="n">labelsv</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">upB</span><span class="p">)</span>
        <span class="n">cross</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;epoch=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; crossentropy(train): &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>\
            <span class="s1">&#39;epoch=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; crossentropy(validation): &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ans2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#emp.append(str(ans2)+&#39;\n&#39;)</span>
        <span class="c1">#emptrain.append(str(ans)+&#39;\n&#39;)</span>
    <span class="k">return</span> <span class="n">upB</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">cross</span><span class="p">,</span><span class="n">emp</span><span class="p">,</span><span class="n">emptrain</span>

<span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">upB</span><span class="p">):</span>
    <span class="n">outlabels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">alphaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">upA</span><span class="p">)</span>
        <span class="n">betaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">upB</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">alphaw</span><span class="p">)</span>

        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">))</span>
        <span class="n">zw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">zw</span><span class="p">,</span><span class="n">betaw</span><span class="p">)</span>
        <span class="n">yhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">yhat</span><span class="p">)</span>

        <span class="n">outlabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outlabels</span>

<span class="k">def</span> <span class="nf">prep</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">myfile</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">col1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># one hot labels</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">col1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">col1</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">col1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">labels</span><span class="p">[</span><span class="n">rows</span><span class="p">,</span><span class="n">col1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">col_max</span> <span class="o">=</span> <span class="n">col1</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>

    <span class="k">return</span> <span class="nb">input</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span><span class="n">col_max</span>

<span class="k">def</span> <span class="nf">prepval</span><span class="p">(</span><span class="n">valfile</span><span class="p">,</span><span class="n">col_max</span><span class="p">):</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">valfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">myfile</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">col1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># one hot labels</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">col1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">col_max</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">col1</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">labels</span><span class="p">[</span><span class="n">rows</span><span class="p">,</span><span class="n">col1</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">return</span> <span class="nb">input</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">labels</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

    <span class="nb">input</span><span class="p">,</span><span class="n">col1</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">col_max</span> <span class="o">=</span> <span class="n">prep</span><span class="p">(</span><span class="n">train_input</span><span class="p">)</span>

    <span class="c1"># init_flag</span>
    <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span> <span class="o">=</span> <span class="n">initialize</span><span class="p">(</span><span class="n">hidden_units</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">init_flag</span><span class="p">)</span>

    <span class="c1"># bias</span>
    <span class="n">a_ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>     
    <span class="n">upA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">a_ones</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">b_ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">upB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">b_ones</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">inputv</span><span class="p">,</span><span class="n">col1v</span><span class="p">,</span><span class="n">labelsv</span> <span class="o">=</span> <span class="n">prepval</span><span class="p">(</span><span class="n">validation_input</span><span class="p">,</span><span class="n">col_max</span><span class="p">)</span>

    <span class="c1"># run on training</span>
    <span class="n">upB</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">cross</span><span class="p">,</span><span class="n">emp</span><span class="p">,</span><span class="n">emptrain</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">upB</span><span class="p">,</span><span class="n">num_epoch</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span><span class="n">learning_rate</span><span class="p">,</span><span class="n">inputv</span><span class="p">,</span><span class="n">labelsv</span><span class="p">)</span>
    <span class="n">outlabels</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">upB</span><span class="p">)</span>
    <span class="n">error1</span> <span class="o">=</span> <span class="n">erate</span><span class="p">(</span><span class="n">col1</span><span class="p">,</span><span class="n">outlabels</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">train_out</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="n">outlabels</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># run on validation</span>
    <span class="n">outlabels</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">inputv</span><span class="p">,</span><span class="n">upA</span><span class="p">,</span><span class="n">upB</span><span class="p">)</span>
    <span class="n">error2</span> <span class="o">=</span> <span class="n">erate</span><span class="p">(</span><span class="n">col1v</span><span class="p">,</span><span class="n">outlabels</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">validation_out</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span><span class="n">outlabels</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># metrics out</span>
    <span class="n">cross</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;error(train): &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">error1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>\
        <span class="s1">&#39;error(validation): &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">error2</span><span class="p">))</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">metrics_out</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">cross</span><span class="p">)</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Below are extra metrics that I used when graphing my model</span>

<span class="sd">    with open(emp_metrics,&#39;w&#39;) as outfile:  #validation only</span>
<span class="sd">        outfile.writelines(emp)</span>

<span class="sd">    with open(emp_train,&#39;w&#39;) as outfile:    #train only</span>
<span class="sd">        outfile.writelines(emptrain)</span>
<span class="sd">    &#39;&#39;&#39;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>

</body>







</html>
